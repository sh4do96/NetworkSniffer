
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Przeglądarka sesji</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
            h1 { color: #333; }
            .url-list { width: 30%; float: left; overflow-y: auto; height: 600px; }
            .url-details { width: 65%; float: right; border-left: 1px solid #ccc; padding-left: 20px; height: 600px; overflow-y: auto; }
            .url-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
            .url-item:hover { background-color: #f5f5f5; }
            .selected { background-color: #e0e0e0; }
            .request-details { margin-top: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
            .cookie-table { width: 100%; border-collapse: collapse; }
            .cookie-table th, .cookie-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .cookie-table th { background-color: #f2f2f2; }
            .headers-table { width: 100%; border-collapse: collapse; }
            .headers-table th, .headers-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .headers-table th { background-color: #f2f2f2; }
            .replay-btn { background-color: #4CAF50; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
            .replay-btn:hover { background-color: #45a049; }
            .error-message { color: #a00; padding: 10px; background-color: #fff8f8; border-left: 4px solid #a00; }
            pre { white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 3px; }
            .binary-data-notice { color: #666; font-style: italic; }
            .toggle-data-btn { cursor: pointer; color: #0066cc; text-decoration: underline; }
        </style>
    </head>
    <body>
        <h1>Przeglądarka sesji</h1>

        <div class="url-list" id="urlList">
            <h2>Zarejestrowane URL</h2>
            <div id="urls"></div>
        </div>

        <div class="url-details" id="urlDetails">
            <h2>Szczegóły żądania</h2>
            <div id="details">Wybierz URL z listy po lewej stronie</div>
        </div>

        <script>
            // Funkcja formatująca dane
            function formatData(data) {
                if (!data) return "<em>Brak danych</em>";

                // Obsługa obiektów danych binarnych
                if (typeof data === 'object' && data.encoding === 'base64') {
                    return `<p class="binary-data-notice">Dane binarne (${data.size} bajtów)</p>
                           <p><span class="toggle-data-btn" onclick="toggleElement(this.nextElementSibling)">Pokaż dane base64</span>
                           <pre style="display:none;">${data.data}</pre></p>`;
                }

                // Jeśli dane zawierają informację o danych binarnych
                if (typeof data === 'string' && data.startsWith('<Binary data:')) {
                    return `<p class="binary-data-notice">${data}</p>`;
                }

                // Próba rozpoznania formatu JSON
                if (typeof data === 'string') {
                    try {
                        const jsonObj = JSON.parse(data);
                        return `<pre>${JSON.stringify(jsonObj, null, 2)}</pre>`;
                    } catch (e) {
                        // To nie JSON, potraktuj jako zwykły tekst
                    }

                    // Sprawdź, czy to mogą być dane binarne (niepoprawne znaki)
                    if (/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/.test(data.substring(0, 200))) {
                        return `<p class="binary-data-notice">Potencjalne dane binarne (${data.length} znaków)</p>
                               <p><span class="toggle-data-btn" onclick="toggleElement(this.nextElementSibling)">Pokaż surowe dane</span>
                               <pre style="display:none;">${escapeHtml(data)}</pre></p>`;
                    }

                    // Zwykły tekst - wyświetl bezpiecznie
                    return `<pre>${escapeHtml(data)}</pre>`;
                }

                // Jeśli to obiekt, wyświetl go ładnie
                return `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
            }

            // Funkcja do przełączania widoczności elementu
            function toggleElement(element) {
                if (element.style.display === 'none') {
                    element.style.display = 'block';
                    if (element.previousElementSibling) {
                        element.previousElementSibling.textContent = element.previousElementSibling.textContent.replace('Pokaż', 'Ukryj');
                    }
                } else {
                    element.style.display = 'none';
                    if (element.previousElementSibling) {
                        element.previousElementSibling.textContent = element.previousElementSibling.textContent.replace('Ukryj', 'Pokaż');
                    }
                }
            }

            // Funkcja zabezpieczająca HTML
            function escapeHtml(text) {
                if (typeof text !== 'string') {
                    text = String(text);
                }
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // Pobierz dane
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    const urlsContainer = document.getElementById('urls');
                    const detailsContainer = document.getElementById('details');

                    if (Object.keys(data).length === 0) {
                        detailsContainer.innerHTML = '<p class="error-message">Brak zarejestrowanych danych.</p>';
                        return;
                    }

                    // Wyświetl listę URL
                    Object.keys(data).forEach(url => {
                        const div = document.createElement('div');
                        div.className = 'url-item';
                        div.textContent = url + ` (${data[url].length})`;
                        div.onclick = () => {
                            try {
                                // Usuń poprzednie zaznaczenie
                                document.querySelectorAll('.url-item').forEach(el => el.classList.remove('selected'));
                                div.classList.add('selected');

                                // Wyświetl szczegóły żądań
                                const requests = data[url];
                                let detailsHtml = `<h3>URL: ${escapeHtml(url)}</h3>`;

                                if (requests.length === 0) {
                                    detailsHtml += '<p class="error-message">Brak zapisanych żądań dla tego URL.</p>';
                                } else {
                                    requests.forEach((req, index) => {
                                        detailsHtml += `
                                        <div class="request-details">
                                            <h4>Żądanie #${index + 1} (${req.timestamp || 'Czas nieznany'})</h4>
                                            <p><strong>Metoda:</strong> ${req.method || 'Nieznana'}</p>
                                            <p><strong>Protokół:</strong> ${req.protocol || 'Nieznany'}</p>`;

                                        // Dodaj informacje o IP i portach jeśli są dostępne
                                        if (req.src_ip || req.dst_ip) {
                                            detailsHtml += `<p>`;
                                            if (req.src_ip) detailsHtml += `<strong>Źródło:</strong> ${req.src_ip}${req.sport ? ':'+req.sport : ''} `;
                                            if (req.dst_ip) detailsHtml += `<strong>Cel:</strong> ${req.dst_ip}${req.dport ? ':'+req.dport : ''}`;
                                            detailsHtml += `</p>`;
                                        }

                                        // Nagłówki
                                        if (req.headers && Object.keys(req.headers).length > 0) {
                                            detailsHtml += `
                                            <h5>Nagłówki:</h5>
                                            <p><span class="toggle-data-btn" onclick="toggleElement(document.getElementById('headers-${index}'))">Pokaż nagłówki</span></p>
                                            <table id="headers-${index}" class="headers-table" style="display:none;">
                                                <tr>
                                                    <th>Nagłówek</th>
                                                    <th>Wartość</th>
                                                </tr>`;

                                            for (const [header, value] of Object.entries(req.headers)) {
                                                detailsHtml += `
                                                    <tr>
                                                        <td>${escapeHtml(header)}</td>
                                                        <td>${escapeHtml(value)}</td>
                                                    </tr>`;
                                            }

                                            detailsHtml += `</table>`;
                                        }

                                        // Ciasteczka
                                        if (req.cookies && Object.keys(req.cookies).length > 0) {
                                            detailsHtml += `
                                            <h5>Ciasteczka (${Object.keys(req.cookies).length}):</h5>
                                            <p><span class="toggle-data-btn" onclick="toggleElement(document.getElementById('cookies-${index}'))">Pokaż ciasteczka</span></p>
                                            <table id="cookies-${index}" class="cookie-table" style="display:none;">
                                                <tr>
                                                    <th>Nazwa</th>
                                                    <th>Wartość</th>
                                                </tr>`;

                                            for (const [name, value] of Object.entries(req.cookies)) {
                                                detailsHtml += `
                                                    <tr>
                                                        <td>${escapeHtml(name)}</td>
                                                        <td>${escapeHtml(value)}</td>
                                                    </tr>`;
                                            }

                                            detailsHtml += `</table>`;
                                        }

                                        // Dane POST
                                        if (req.post_data) {
                                            detailsHtml += `
                                            <h5>Dane POST:</h5>
                                            ${formatData(req.post_data)}`;
                                        }

                                        // Przycisk odtwarzania (tylko dla HTTP, nie HTTPS)
                                        const isHTTPS = url.startsWith('https://') || req.protocol === 'HTTPS';
                                        if (!isHTTPS) {
                                            detailsHtml += `
                                            <p style="margin-top: 15px;">
                                                <button class="replay-btn" onclick="replayRequest('${escapeHtml(url)}', ${index})">Odtwórz żądanie</button>
                                            </p>`;
                                        } else {
                                            detailsHtml += `
                                            <p style="margin-top: 15px; color: #666;">
                                                <em>Nie można odtworzyć żądania HTTPS ze względu na szyfrowanie.</em>
                                            </p>`;
                                        }

                                        detailsHtml += `</div>`;
                                    });
                                }

                                detailsContainer.innerHTML = detailsHtml;
                            } catch (error) {
                                console.error('Błąd podczas wyświetlania danych:', error);
                                detailsContainer.innerHTML = `
                                    <div class="error-message">
                                        <p>Wystąpił błąd podczas próby wyświetlenia szczegółów żądania: ${error.message}</p>
                                        <p>Może to być spowodowane nieprawidłowym formatem danych lub danymi binarnymi.</p>
                                    </div>`;
                            }
                        };

                        urlsContainer.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych:', error);
                    document.getElementById('details').innerHTML = `
                        <div class="error-message">
                            <p>Błąd podczas pobierania danych: ${error.message}</p>
                            <p>Sprawdź, czy plik danych istnieje i ma prawidłowy format.</p>
                        </div>`;
                });

            // Funkcja do odtwarzania żądania
            function replayRequest(url, index) {
                fetch('/data')
                    .then(response => response.json())
                    .then(data => {
                        const request = data[url][index];

                        // Utwórz iframe aby symulować przeglądarkę
                        const iframe = document.createElement('iframe');
                        iframe.style.width = '100%';
                        iframe.style.height = '400px';
                        iframe.style.border = '1px solid #ccc';
                        iframe.name = `iframe_${Date.now()}`;

                        // Dodaj iframe do strony
                        const detailsDiv = document.querySelector(`#details .request-details:nth-child(${index + 2})`);
                        detailsDiv.appendChild(document.createElement('hr'));
                        detailsDiv.appendChild(document.createElement('h5')).textContent = 'Wynik odtworzenia:';
                        detailsDiv.appendChild(iframe);

                        // Dla HTTPS połączeń zwracamy informację, że odtwarzanie nie jest możliwe
                        if (url.startsWith('https://') || request.protocol === 'HTTPS') {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            iframeDoc.body.innerHTML = `
                                <h3>Nie można odtworzyć żądania HTTPS</h3>
                                <p>Żądania HTTPS są szyfrowane i nie mogą być odtworzone bezpośrednio.</p>
                                <p>Możesz ręcznie odwiedzić adres: <a href="${url}" target="_blank">${url}</a></p>
                            `;
                            return;
                        }

                        try {
                            // Utwórz formularz do wysłania żądania
                            const form = document.createElement('form');
                            form.method = request.method || 'GET';
                            form.target = iframe.name;

                            // Utwórz prawidłowy URL bez protokołu
                            let formUrl = url;
                            if (formUrl.startsWith('http://')) {
                                formUrl = formUrl.substring(7);
                            }
                            form.action = `http://${formUrl}`;

                            // Dodaj dane POST jeśli istnieją
                            if (request.post_data) {
                                try {
                                    // Sprawdź, czy dane są w formacie application/x-www-form-urlencoded
                                    if (typeof request.post_data === 'string' && 
                                        request.post_data.includes('=') && 
                                        !request.post_data.startsWith('{') && 
                                        !request.post_data.startsWith('[')) {

                                        const dataParams = new URLSearchParams(request.post_data);
                                        dataParams.forEach((value, key) => {
                                            const input = document.createElement('input');
                                            input.type = 'hidden';
                                            input.name = key;
                                            input.value = value;
                                            form.appendChild(input);
                                        });
                                    } else {
                                        // Jeśli to nie jest format formularza, dodaj jako raw data
                                        const input = document.createElement('input');
                                        input.type = 'hidden';
                                        input.name = 'rawData';
                                        input.value = typeof request.post_data === 'object' ? 
                                                     JSON.stringify(request.post_data) : 
                                                     String(request.post_data);
                                        form.appendChild(input);
                                    }
                                } catch (error) {
                                    console.error('Błąd podczas przetwarzania danych POST:', error);
                                    // Dodaj informację o błędzie do iframe
                                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                    iframeDoc.body.innerHTML = `
                                        <h3>Błąd podczas przetwarzania danych POST</h3>
                                        <p>${error.message}</p>
                                    `;
                                    return;
                                }
                            }

                            // Dodaj formularz do strony i wyślij
                            document.body.appendChild(form);
                            form.submit();
                            document.body.removeChild(form);
                        } catch (error) {
                            console.error('Błąd podczas odtwarzania żądania:', error);
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            iframeDoc.body.innerHTML = `
                                <h3>Błąd podczas odtwarzania żądania</h3>
                                <p>${error.message}</p>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Błąd podczas odtwarzania żądania:', error);
                        alert(`Błąd podczas odtwarzania żądania: ${error.message}`);
                    });
            }
        </script>
    </body>
    </html>
                